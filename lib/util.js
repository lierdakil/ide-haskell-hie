"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const os_1 = require("os");
const atom_haskell_utils_1 = require("atom-haskell-utils");
exports.getRootDirFallback = atom_haskell_utils_1.getRootDirFallback;
exports.getRootDir = atom_haskell_utils_1.getRootDir;
exports.isDirectory = atom_haskell_utils_1.isDirectory;
let debuglog = [];
const logKeep = 30000;
function savelog(...messages) {
    const ts = Date.now();
    debuglog.push({
        timestamp: ts,
        messages,
    });
    let ks = 0;
    for (const v of debuglog) {
        if (ts - v.timestamp >= logKeep) {
            break;
        }
        ks++;
    }
    debuglog.splice(0, ks);
}
function debug(...messages) {
    if (atom.config.get('haskell-ghc-mod.debug')) {
        console.log('haskell-ghc-mod debug:', ...messages);
    }
    savelog(...messages.map((v) => JSON.stringify(v)));
}
exports.debug = debug;
function warn(...messages) {
    console.warn('haskell-ghc-mod warning:', ...messages);
    savelog(...messages.map((v) => JSON.stringify(v)));
}
exports.warn = warn;
function error(...messages) {
    console.error('haskell-ghc-mod error:', ...messages);
    savelog(...messages.map((v) => JSON.stringify(v)));
}
exports.error = error;
function getDebugLog() {
    const ts = Date.now();
    debuglog = debuglog.filter(({ timestamp }) => ts - timestamp < logKeep);
    return debuglog
        .map(({ timestamp, messages }) => `${(timestamp - ts) / 1000}s: ${messages.join(',')}`)
        .join(os_1.EOL);
}
exports.getDebugLog = getDebugLog;
function getSymbolAtPoint(editor, point) {
    const [scope] = editor
        .scopeDescriptorForBufferPosition(point)
        .getScopesArray()
        .slice(-1);
    if (scope) {
        const range = editor.bufferRangeForScopeAtPosition(scope, point);
        if (range && !range.isEmpty()) {
            const symbol = editor.getTextInBufferRange(range);
            return { scope, range, symbol };
        }
    }
    return undefined;
}
exports.getSymbolAtPoint = getSymbolAtPoint;
function getSymbolInRange(editor, crange) {
    const buffer = editor.getBuffer();
    if (crange.isEmpty()) {
        return getSymbolAtPoint(editor, crange.start);
    }
    else {
        return {
            symbol: buffer.getTextInRange(crange),
            range: crange,
        };
    }
}
exports.getSymbolInRange = getSymbolInRange;
function handleException(_target, _key, desc) {
    return Object.assign({}, desc, { async value(...args) {
            try {
                return await desc.value.call(this, ...args);
            }
            catch (e) {
                debug(e);
                const upi = await this.upi;
                upi.setStatus({
                    status: 'warning',
                    detail: e.toString(),
                });
                return new Promise(() => {
                });
            }
        } });
}
exports.handleException = handleException;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsMkJBQXdCO0FBQ3hCLDJEQUFnRjtBQUl2RSw2QkFKQSx1Q0FBa0IsQ0FJQTtBQUFFLHFCQUpBLCtCQUFVLENBSUE7QUFBRSxzQkFKQSxnQ0FBVyxDQUlBO0FBRXBELElBQUksUUFBUSxHQUFxRCxFQUFFLENBQUE7QUFDbkUsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFBO0FBRXJCLGlCQUFpQixHQUFHLFFBQWtCO0lBQ3BDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQTtJQUNyQixRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ1osU0FBUyxFQUFFLEVBQUU7UUFDYixRQUFRO0tBQ1QsQ0FBQyxDQUFBO0lBQ0YsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQ1YsS0FBSyxNQUFNLENBQUMsSUFBSSxRQUFRLEVBQUU7UUFDeEIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLFNBQVMsSUFBSSxPQUFPLEVBQUU7WUFDL0IsTUFBSztTQUNOO1FBQ0QsRUFBRSxFQUFFLENBQUE7S0FDTDtJQUNELFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3hCLENBQUM7QUFFRCxlQUFzQixHQUFHLFFBQWU7SUFDdEMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFO1FBRTVDLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQTtLQUNuRDtJQUNELE9BQU8sQ0FBQyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQ3BELENBQUM7QUFORCxzQkFNQztBQUVELGNBQXFC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O2dCQUNyRCxHQUFHLENBQUMsU0FBUyxDQUFDO29CQUNaLE1BQU0sRUFBRSxTQUFTO29CQUNqQixNQUFNLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRTtpQkFDckIsQ0FBQyxDQUFBO2dCQUVGLE9BQU8sSUFBSSxPQUFPLENBQUMsR0FBRyxFQUFFO2dCQUV4QixDQUFDLENBQUMsQ0FBQTthQUNIO1FBQ0gsQ0FBQyxJQUNGO0FBQ0gsQ0FBQztBQXpCRCwwQ0F5QkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSYW5nZSwgUG9pbnQsIFRleHRFZGl0b3IgfSBmcm9tICdhdG9tJ1xuaW1wb3J0ICogYXMgQ1AgZnJvbSAnY2hpbGRfcHJvY2VzcydcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJ1xuaW1wb3J0IHsgZ2V0Um9vdERpckZhbGxiYWNrLCBnZXRSb290RGlyLCBpc0RpcmVjdG9yeSB9IGZyb20gJ2F0b20taGFza2VsbC11dGlscydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuXG50eXBlIEV4ZWNPcHRzID0gQ1AuRXhlY0ZpbGVPcHRpb25zV2l0aFN0cmluZ0VuY29kaW5nXG5leHBvcnQgeyBnZXRSb290RGlyRmFsbGJhY2ssIGdldFJvb3REaXIsIGlzRGlyZWN0b3J5LCBFeGVjT3B0cyB9XG5cbmxldCBkZWJ1Z2xvZzogQXJyYXk8eyB0aW1lc3RhbXA6IG51bWJlcjsgbWVzc2FnZXM6IHN0cmluZ1tdIH0+ID0gW11cbmNvbnN0IGxvZ0tlZXAgPSAzMDAwMCAvLyBtc1xuXG5mdW5jdGlvbiBzYXZlbG9nKC4uLm1lc3NhZ2VzOiBzdHJpbmdbXSkge1xuICBjb25zdCB0cyA9IERhdGUubm93KClcbiAgZGVidWdsb2cucHVzaCh7XG4gICAgdGltZXN0YW1wOiB0cyxcbiAgICBtZXNzYWdlcyxcbiAgfSlcbiAgbGV0IGtzID0gMFxuICBmb3IgKGNvbnN0IHYgb2YgZGVidWdsb2cpIHtcbiAgICBpZiAodHMgLSB2LnRpbWVzdGFtcCA+PSBsb2dLZWVwKSB7XG4gICAgICBicmVha1xuICAgIH1cbiAgICBrcysrXG4gIH1cbiAgZGVidWdsb2cuc3BsaWNlKDAsIGtzKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVidWcoLi4ubWVzc2FnZXM6IGFueVtdKSB7XG4gIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2hhc2tlbGwtZ2hjLW1vZC5kZWJ1ZycpKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25zb2xlXG4gICAgY29uc29sZS5sb2coJ2hhc2tlbGwtZ2hjLW1vZCBkZWJ1ZzonLCAuLi5tZXNzYWdlcylcbiAgfVxuICBzYXZlbG9nKC4uLm1lc3NhZ2VzLm1hcCgodikgPT4gSlNPTi5zdHJpbmdpZnkodikpKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gd2FybiguLi5tZXNzYWdlczogYW55W10pIHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25zb2xlXG4gIGNvbnNvbGUud2FybignaGFza2VsbC1naGMtbW9kIHdhcm5pbmc6JywgLi4ubWVzc2FnZXMpXG4gIHNhdmVsb2coLi4ubWVzc2FnZXMubWFwKCh2KSA9PiBKU09OLnN0cmluZ2lmeSh2KSkpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlcnJvciguLi5tZXNzYWdlczogYW55W10pIHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25zb2xlXG4gIGNvbnNvbGUuZXJyb3IoJ2hhc2tlbGwtZ2hjLW1vZCBlcnJvcjonLCAuLi5tZXNzYWdlcylcbiAgc2F2ZWxvZyguLi5tZXNzYWdlcy5tYXAoKHYpID0+IEpTT04uc3RyaW5naWZ5KHYpKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldERlYnVnTG9nKCkge1xuICBjb25zdCB0cyA9IERhdGUubm93KClcbiAgZGVidWdsb2cgPSBkZWJ1Z2xvZy5maWx0ZXIoKHsgdGltZXN0YW1wIH0pID0+IHRzIC0gdGltZXN0YW1wIDwgbG9nS2VlcClcbiAgcmV0dXJuIGRlYnVnbG9nXG4gICAgLm1hcChcbiAgICAgICh7IHRpbWVzdGFtcCwgbWVzc2FnZXMgfSkgPT5cbiAgICAgICAgYCR7KHRpbWVzdGFtcCAtIHRzKSAvIDEwMDB9czogJHttZXNzYWdlcy5qb2luKCcsJyl9YCxcbiAgICApXG4gICAgLmpvaW4oRU9MKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3ltYm9sQXRQb2ludChlZGl0b3I6IFRleHRFZGl0b3IsIHBvaW50OiBQb2ludCkge1xuICBjb25zdCBbc2NvcGVdID0gZWRpdG9yXG4gICAgLnNjb3BlRGVzY3JpcHRvckZvckJ1ZmZlclBvc2l0aW9uKHBvaW50KVxuICAgIC5nZXRTY29wZXNBcnJheSgpXG4gICAgLnNsaWNlKC0xKVxuICBpZiAoc2NvcGUpIHtcbiAgICBjb25zdCByYW5nZSA9IGVkaXRvci5idWZmZXJSYW5nZUZvclNjb3BlQXRQb3NpdGlvbihzY29wZSwgcG9pbnQpXG4gICAgaWYgKHJhbmdlICYmICFyYW5nZS5pc0VtcHR5KCkpIHtcbiAgICAgIGNvbnN0IHN5bWJvbCA9IGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShyYW5nZSlcbiAgICAgIHJldHVybiB7IHNjb3BlLCByYW5nZSwgc3ltYm9sIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3ltYm9sSW5SYW5nZShlZGl0b3I6IFRleHRFZGl0b3IsIGNyYW5nZTogUmFuZ2UpIHtcbiAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpXG4gIGlmIChjcmFuZ2UuaXNFbXB0eSgpKSB7XG4gICAgcmV0dXJuIGdldFN5bWJvbEF0UG9pbnQoZWRpdG9yLCBjcmFuZ2Uuc3RhcnQpXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN5bWJvbDogYnVmZmVyLmdldFRleHRJblJhbmdlKGNyYW5nZSksXG4gICAgICByYW5nZTogY3JhbmdlLFxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFuZGxlRXhjZXB0aW9uPFQ+KFxuICBfdGFyZ2V0OiB7IHVwaTogVVBJLklVUElJbnN0YW5jZSB8IFByb21pc2U8VVBJLklVUElJbnN0YW5jZT4gfSxcbiAgX2tleTogc3RyaW5nLFxuICBkZXNjOiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjwoLi4uYXJnczogYW55W10pID0+IFByb21pc2U8VD4+LFxuKTogVHlwZWRQcm9wZXJ0eURlc2NyaXB0b3I8KC4uLmFyZ3M6IGFueVtdKSA9PiBQcm9taXNlPFQ+PiB7XG4gIHJldHVybiB7XG4gICAgLi4uZGVzYyxcbiAgICBhc3luYyB2YWx1ZSguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgcmV0dXJuIGF3YWl0IGRlc2MudmFsdWUhLmNhbGwodGhpcywgLi4uYXJncylcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgZGVidWcoZSlcbiAgICAgICAgY29uc3QgdXBpOiBVUEkuSVVQSUluc3RhbmNlID0gYXdhaXQgKHRoaXMgYXMgYW55KS51cGlcbiAgICAgICAgdXBpLnNldFN0YXR1cyh7XG4gICAgICAgICAgc3RhdHVzOiAnd2FybmluZycsXG4gICAgICAgICAgZGV0YWlsOiBlLnRvU3RyaW5nKCksXG4gICAgICAgIH0pXG4gICAgICAgIC8vIFRPRE86IHJldHVybmluZyBhIHByb21pc2UgdGhhdCBuZXZlciByZXNvbHZlcy4uLiB1Z2x5LCBidXQgd29ya3M/XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgoKSA9PiB7XG4gICAgICAgICAgLyogbm9vcCAqL1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0sXG4gIH1cbn1cbiJdfQ==