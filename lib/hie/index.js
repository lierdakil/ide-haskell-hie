"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_languageclient_1 = require("atom-languageclient");
const atom_1 = require("atom");
const cp = require("child_process");
const autocomplete_adapter_1 = require("atom-languageclient/build/lib/adapters/autocomplete-adapter");
const apply_edit_adapter_1 = require("atom-languageclient/build/lib/adapters/apply-edit-adapter");
const notifications_adapter_1 = require("atom-languageclient/build/lib/adapters/notifications-adapter");
const document_sync_adapter_1 = require("atom-languageclient/build/lib/adapters/document-sync-adapter");
class HieLanguageClient extends atom_languageclient_1.BaseLanguageClient {
    constructor() {
        super();
        this.emitter = new atom_1.Emitter();
        this.stderrBuf = '';
        this.messages = new Map();
        this.activate();
    }
    onError(cb) {
        return this.emitter.on('error', cb);
    }
    onWarning(cb) {
        return this.emitter.on('warn', cb);
    }
    async getType(buffer, range) {
        const filePath = buffer.getPath();
        if (filePath === undefined)
            throw new Error('No editor URI');
        const res = await this.executeCommand(buffer, 'ghcmod:type', {
            file: atom_languageclient_1.Convert.pathToUri(filePath),
            include_constraints: true,
            pos: atom_languageclient_1.Convert.atomRangeToLSRange(range).start,
        });
        for (const [r, t] of res) {
            const rr = atom_languageclient_1.Convert.lsRangeToAtomRange(r);
            if (rr.containsRange(range))
                return { type: t, range: rr };
        }
        throw new Error('No type found');
    }
    async getInfo(buffer, symbol) {
        const filePath = buffer.getPath();
        if (filePath === undefined)
            throw new Error('No editor URI');
        const res = await this.executeCommand(buffer, 'ghcmod:info', {
            file: atom_languageclient_1.Convert.pathToUri(filePath),
            expr: symbol,
        });
        return res;
    }
    async restart() {
        return this.restartAllServers();
    }
    async deactivate() {
        const res = super.deactivate();
        this.emitter.emit('destroyed');
        this.emitter.dispose();
        return res;
    }
    onDidDestroy(cb) {
        return this.emitter.on('destroyed', cb);
    }
    onMessages(cb) {
        return this.emitter.on('messages', cb);
    }
    getMessages() {
        return flattenOne(this.messages.values());
    }
    setReportBusy(f) {
        this.reportBusy = f;
    }
    provideAutocomplete() {
        return {
            selector: this.getGrammarScopes()
                .map((g) => (g.includes('.') ? '.' + g : g))
                .join(', '),
            inclusionPriority: 1,
            suggestionPriority: 2,
            excludeLowerPriority: false,
            getSuggestions: this.getSuggestions.bind(this),
            getSuggestionDetailsOnSelect: this.getSuggestionDetailsOnSelect.bind(this),
        };
    }
    async getSuggestions(request) {
        const server = await this._serverManager.getServer(request.editor);
        if (server === null || !autocomplete_adapter_1.default.canAdapt(server.capabilities)) {
            return [];
        }
        this.autoComplete = this.autoComplete || new autocomplete_adapter_1.default();
        this._lastAutocompleteRequest = request;
        return this.autoComplete.getSuggestions(server, request, undefined, atom.config.get('autocomplete-plus.minimumWordLength'));
    }
    async getSuggestionDetailsOnSelect(suggestion) {
        const request = this._lastAutocompleteRequest;
        if (!request) {
            return null;
        }
        const server = await this._serverManager.getServer(request.editor);
        if (!server ||
            !autocomplete_adapter_1.default.canResolve(server.capabilities) ||
            !this.autoComplete) {
            return null;
        }
        return this.autoComplete.completeSuggestion(server, suggestion, request);
    }
    preInitialization(conn) {
        super.preInitialization(conn);
        conn.onPublishDiagnostics((params) => {
            const filePath = atom_languageclient_1.Convert.uriToPath(params.uri);
            this.messages.set(params.uri, diagnosticsToResultItems(filePath, params.diagnostics));
            this.emitter.emit('messages', flattenOne(this.messages.values()));
        });
    }
    getLogger() {
        return {
            warn: (...args) => {
                console.warn(...args);
                this.emitter.emit('warn', args);
            },
            error: (...args) => {
                console.error(...args);
                this.emitter.emit('error', args);
            },
            info: (...args) => {
                console.info(...args);
                this.emitter.emit('info', args);
            },
            log: (...args) => {
                console.log(...args);
                this.emitter.emit('log', args);
            },
            debug: (...args) => {
                console.debug(...args);
                this.emitter.emit('debug', args);
            },
        };
    }
    getGrammarScopes() {
        return ['source.haskell'];
    }
    getLanguageName() {
        return 'Haskell';
    }
    getServerName() {
        return 'haskell-ide-engine';
    }
    startServerProcess(projectPath) {
        return cp.spawn('stack', [
            'exec',
            '--',
            atom.config.get('ide-haskell-hie.hiePath'),
            '--lsp',
            '--debug',
        ], { cwd: projectPath });
    }
    handleServerStderr(stderr, projectPath) {
        const [first, ...lines] = stderr.split('\n');
        this.stderrBuf += first;
        if (lines.length > 0) {
            this.logger.warn(`stderr[${projectPath}]: ${this.stderrBuf}`);
            lines.slice(0, -1).forEach((x) => {
                this.logger.warn(`stderr[${projectPath}]: ${x}`);
            });
            this.stderrBuf = lines[lines.length - 1];
        }
    }
    startExclusiveAdapters(server) {
        apply_edit_adapter_1.default.attach(server.connection);
        notifications_adapter_1.default.attach(server.connection, this.name, server.projectPath);
        if (document_sync_adapter_1.default.canAdapt(server.capabilities)) {
            server.disposable.add(new document_sync_adapter_1.default(server.connection, (editor) => this.shouldSyncForEditor(editor, server.projectPath), server.capabilities.textDocumentSync, this.reportBusyWhile.bind(this)));
        }
    }
    async reportBusyWhile(message, promiseGenerator) {
        if (this.reportBusy) {
            return this.reportBusy(message, promiseGenerator);
        }
        else {
            this.logger.info(message);
            return promiseGenerator();
        }
    }
    async executeCommand(buffer, command, ...args) {
        const conn = await this.getConnectionForBuffer(buffer);
        return conn.executeCommand({
            command,
            arguments: args,
        });
    }
    async getConnectionForBuffer(buffer) {
        const conn = await this.getConnectionForEditor(editorForBuffer(buffer));
        if (!conn)
            throw new Error('No HIE connection');
        return conn;
    }
}
exports.HieLanguageClient = HieLanguageClient;
function editorForBuffer(buffer) {
    const editor = atom.workspace
        .getTextEditors()
        .find((ed) => ed.getBuffer() === buffer);
    if (!editor) {
        throw new Error(`No editor for a buffer ${buffer.getId()} with path ${buffer.getPath()}`);
    }
    return editor;
}
function severityLSToUPI(severity) {
    switch (severity) {
        case 1:
            return 'error';
        case 2:
            return 'warning';
        case 3:
            return 'lint';
        case 4:
            return 'lint';
        default:
            return 'HIE';
    }
}
function diagnosticsToResultItems(filePath, ds) {
    return ds.map((x) => ({
        message: x.message,
        uri: filePath,
        context: x.source,
        severity: severityLSToUPI(x.severity),
        position: atom_languageclient_1.Convert.lsRangeToAtomRange(x.range).start,
    }));
}
function flattenOne(arr) {
    return [].concat(...arr);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaGllL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkRBSzRCO0FBQzVCLCtCQUE2RDtBQUM3RCxvQ0FBbUM7QUFJbkMsc0dBQTZGO0FBQzdGLGtHQUF3RjtBQUN4Rix3R0FBK0Y7QUFDL0Ysd0dBQThGO0FBTzlGLHVCQUErQixTQUFRLHdDQUFrQjtJQXFCdkQ7UUFDRSxLQUFLLEVBQUUsQ0FBQTtRQW5CRCxZQUFPLEdBWVgsSUFBSSxjQUFPLEVBQUUsQ0FBQTtRQUVULGNBQVMsR0FBRyxFQUFFLENBQUE7UUFDZCxhQUFRLEdBQUcsSUFBSSxHQUFHLEVBQTZCLENBQUE7UUFLckQsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFBO0lBQ2pCLENBQUM7SUFFTSxPQUFPLENBQUMsRUFBeUI7UUFDdEMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFDckMsQ0FBQztJQUVNLFNBQVMsQ0FBQyxFQUF5QjtRQUN4QyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUNwQyxDQUFDO0lBRU0sS0FBSyxDQUFDLE9BQU8sQ0FDbEIsTUFBa0IsRUFDbEIsS0FBWTtRQUVaLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtRQUNqQyxJQUFJLFFBQVEsS0FBSyxTQUFTO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQTtRQUM1RCxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLGFBQWEsRUFBRTtZQUMzRCxJQUFJLEVBQUUsNkJBQU8sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1lBQ2pDLG1CQUFtQixFQUFFLElBQUk7WUFDekIsR0FBRyxFQUFFLDZCQUFPLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSztTQUM3QyxDQUFDLENBQUE7UUFDRixLQUFLLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksR0FBRyxFQUFFO1lBQ3hCLE1BQU0sRUFBRSxHQUFHLDZCQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDeEMsSUFBSSxFQUFFLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQztnQkFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLENBQUE7U0FDM0Q7UUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFBO0lBQ2xDLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQWtCLEVBQUUsTUFBYztRQUNyRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUE7UUFDakMsSUFBSSxRQUFRLEtBQUssU0FBUztZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUE7UUFDNUQsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxhQUFhLEVBQUU7WUFDM0QsSUFBSSxFQUFFLDZCQUFPLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztZQUNqQyxJQUFJLEVBQUUsTUFBTTtTQUNiLENBQUMsQ0FBQTtRQUNGLE9BQU8sR0FBRyxDQUFBO0lBQ1osQ0FBQztJQUVNLEtBQUssQ0FBQyxPQUFPO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUE7SUFDakMsQ0FBQztJQUVNLEtBQUssQ0FBQyxVQUFVO1FBQ3JCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQTtRQUM5QixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUM5QixJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQ3RCLE9BQU8sR0FBRyxDQUFBO0lBQ1osQ0FBQztJQUVNLFlBQVksQ0FBQyxFQUFjO1FBQ2hDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQ3pDLENBQUM7SUFFTSxVQUFVLENBQUMsRUFBcUM7UUFDckQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFDeEMsQ0FBQztJQUVNLFdBQVc7UUFDaEIsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFBO0lBQzNDLENBQUM7SUFFTSxhQUFhLENBQUMsQ0FBYTtRQUNoQyxJQUFJLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQTtJQUNyQixDQUFDO0lBR00sbUJBQW1CO1FBQ3hCLE9BQU87WUFDTCxRQUFRLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixFQUFFO2lCQUM5QixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQzNDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDYixpQkFBaUIsRUFBRSxDQUFDO1lBQ3BCLGtCQUFrQixFQUFFLENBQUM7WUFDckIsb0JBQW9CLEVBQUUsS0FBSztZQUMzQixjQUFjLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQzlDLDRCQUE0QixFQUFFLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQ2xFLElBQUksQ0FDTDtTQUNGLENBQUE7SUFDSCxDQUFDO0lBRVMsS0FBSyxDQUFDLGNBQWMsQ0FDNUIsT0FBcUM7UUFFckMsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDbEUsSUFBSSxNQUFNLEtBQUssSUFBSSxJQUFJLENBQUMsOEJBQW1CLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsRUFBRTtZQUN6RSxPQUFPLEVBQUUsQ0FBQTtTQUNWO1FBRUQsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksOEJBQW1CLEVBQUUsQ0FBQTtRQUNsRSxJQUFJLENBQUMsd0JBQXdCLEdBQUcsT0FBTyxDQUFBO1FBQ3ZDLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQ3JDLE1BQU0sRUFDTixPQUFPLEVBQ1AsU0FBUyxFQUNULElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHFDQUFxQyxDQUFDLENBQzVCLENBQUE7SUFDOUIsQ0FBQztJQUVTLEtBQUssQ0FBQyw0QkFBNEIsQ0FDMUMsVUFBb0Q7UUFFcEQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFBO1FBQzdDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFFWixPQUFPLElBQUksQ0FBQTtTQUNaO1FBQ0QsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDbEUsSUFDRSxDQUFDLE1BQU07WUFDUCxDQUFDLDhCQUFtQixDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO1lBQ3BELENBQUMsSUFBSSxDQUFDLFlBQVksRUFDbEI7WUFFQSxPQUFPLElBQUksQ0FBQTtTQUNaO1FBRUQsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLGtCQUFrQixDQUN6QyxNQUFNLEVBQ04sVUFBVSxFQUNWLE9BQU8sQ0FDb0QsQ0FBQTtJQUMvRCxDQUFDO0lBRVMsaUJBQWlCLENBQUMsSUFBOEI7UUFDeEQsS0FBSyxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzdCLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQ25DLE1BQU0sUUFBUSxHQUFHLDZCQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUM5QyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FDZixNQUFNLENBQUMsR0FBRyxFQUNWLHdCQUF3QixDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsV0FBVyxDQUFDLENBQ3ZELENBQUE7WUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQ25FLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVTLFNBQVM7UUFDakIsT0FBTztZQUNMLElBQUksRUFBRSxDQUFDLEdBQUcsSUFBVyxFQUFFLEVBQUU7Z0JBQ3ZCLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQTtnQkFDckIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFBO1lBQ2pDLENBQUM7WUFDRCxLQUFLLEVBQUUsQ0FBQyxHQUFHLElBQVcsRUFBRSxFQUFFO2dCQUN4QixPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUE7Z0JBQ3RCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUNsQyxDQUFDO1lBQ0QsSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFXLEVBQUUsRUFBRTtnQkFDdkIsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFBO2dCQUNyQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUE7WUFDakMsQ0FBQztZQUNELEdBQUcsRUFBRSxDQUFDLEdBQUcsSUFBVyxFQUFFLEVBQUU7Z0JBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQTtnQkFDcEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFBO1lBQ2hDLENBQUM7WUFDRCxLQUFLLEVBQUUsQ0FBQyxHQUFHLElBQVcsRUFBRSxFQUFFO2dCQUN4QixPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUE7Z0JBQ3RCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUNsQyxDQUFDO1NBQ0YsQ0FBQTtJQUNILENBQUM7SUFFUyxnQkFBZ0I7UUFDeEIsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUE7SUFDM0IsQ0FBQztJQUNTLGVBQWU7UUFDdkIsT0FBTyxTQUFTLENBQUE7SUFDbEIsQ0FBQztJQUNTLGFBQWE7UUFDckIsT0FBTyxvQkFBb0IsQ0FBQTtJQUM3QixDQUFDO0lBRVMsa0JBQWtCLENBQUMsV0FBbUI7UUFHOUMsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUNiLE9BQU8sRUFDUDtZQUNFLE1BQU07WUFDTixJQUFJO1lBQ0osSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUM7WUFDMUMsT0FBTztZQUNQLFNBQVM7U0FDVixFQUNELEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxDQUNyQixDQUFBO0lBQ0gsQ0FBQztJQUVTLGtCQUFrQixDQUFDLE1BQWMsRUFBRSxXQUFtQjtRQUM5RCxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUM1QyxJQUFJLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQTtRQUN2QixJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsV0FBVyxNQUFNLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFBO1lBQzdELEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7Z0JBQy9CLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsV0FBVyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDbEQsQ0FBQyxDQUFDLENBQUE7WUFDRixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFBO1NBQ3pDO0lBQ0gsQ0FBQztJQUVTLHNCQUFzQixDQUFDLE1BQW9CO1FBQ25ELDRCQUFnQixDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDMUMsK0JBQW9CLENBQUMsTUFBTSxDQUN6QixNQUFNLENBQUMsVUFBVSxFQUNqQixJQUFJLENBQUMsSUFBSSxFQUNULE1BQU0sQ0FBQyxXQUFXLENBQ25CLENBQUE7UUFFRCxJQUFJLCtCQUFtQixDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDckQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQ25CLElBQUksK0JBQW1CLENBQ3JCLE1BQU0sQ0FBQyxVQUFVLEVBQ2pCLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFDaEUsTUFBTSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsRUFDcEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQ2hDLENBQ0YsQ0FBQTtTQUNGO0lBQ0gsQ0FBQztJQUVTLEtBQUssQ0FBQyxlQUFlLENBQzdCLE9BQWUsRUFDZixnQkFBa0M7UUFFbEMsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25CLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQTtTQUNsRDthQUFNO1lBQ0wsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7WUFDekIsT0FBTyxnQkFBZ0IsRUFBRSxDQUFBO1NBQzFCO0lBQ0gsQ0FBQztJQW1CTyxLQUFLLENBQUMsY0FBYyxDQUMxQixNQUFrQixFQUNsQixPQUFlLEVBQ2YsR0FBRyxJQUFXO1FBRWQsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDdEQsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDO1lBQ3pCLE9BQU87WUFDUCxTQUFTLEVBQUUsSUFBSTtTQUNoQixDQUFDLENBQUE7SUFDSixDQUFDO0lBQ08sS0FBSyxDQUFDLHNCQUFzQixDQUFDLE1BQWtCO1FBQ3JELE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO1FBQ3ZFLElBQUksQ0FBQyxJQUFJO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO1FBQy9DLE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztDQUNGO0FBaFNELDhDQWdTQztBQUVELHlCQUF5QixNQUFrQjtJQUN6QyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUztTQUMxQixjQUFjLEVBQUU7U0FDaEIsSUFBSSxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLEtBQUssTUFBTSxDQUFDLENBQUE7SUFDMUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUNYLE1BQU0sSUFBSSxLQUFLLENBQ2IsMEJBQTBCLE1BQU0sQ0FBQyxLQUFLLEVBQUUsY0FBYyxNQUFNLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FDekUsQ0FBQTtLQUNGO0lBQ0QsT0FBTyxNQUFNLENBQUE7QUFDZixDQUFDO0FBRUQseUJBQXlCLFFBQStCO0lBQ3RELFFBQVEsUUFBUSxFQUFFO1FBQ2hCLEtBQUssQ0FBQztZQUNKLE9BQU8sT0FBTyxDQUFBO1FBQ2hCLEtBQUssQ0FBQztZQUNKLE9BQU8sU0FBUyxDQUFBO1FBQ2xCLEtBQUssQ0FBQztZQUNKLE9BQU8sTUFBTSxDQUFBO1FBQ2YsS0FBSyxDQUFDO1lBQ0osT0FBTyxNQUFNLENBQUE7UUFDZjtZQUNFLE9BQU8sS0FBSyxDQUFBO0tBQ2Y7QUFDSCxDQUFDO0FBRUQsa0NBQ0UsUUFBZ0IsRUFDaEIsRUFBa0I7SUFFbEIsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFtQixFQUFFLENBQUMsQ0FBQztRQUNyQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLE9BQU87UUFDbEIsR0FBRyxFQUFFLFFBQVE7UUFDYixPQUFPLEVBQUUsQ0FBQyxDQUFDLE1BQU07UUFDakIsUUFBUSxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO1FBQ3JDLFFBQVEsRUFBRSw2QkFBTyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLO0tBQ3BELENBQUMsQ0FBQyxDQUFBO0FBQ0wsQ0FBQztBQUVELG9CQUF1QixHQUEwQjtJQUMvQyxPQUFRLEVBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQTtBQUNuQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQmFzZUxhbmd1YWdlQ2xpZW50LFxuICBDb252ZXJ0LFxuICBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXG4gIEFjdGl2ZVNlcnZlcixcbn0gZnJvbSAnYXRvbS1sYW5ndWFnZWNsaWVudCdcbmltcG9ydCB7IFRleHRCdWZmZXIsIFRleHRFZGl0b3IsIEVtaXR0ZXIsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCAqIGFzIGNwIGZyb20gJ2NoaWxkX3Byb2Nlc3MnXG5pbXBvcnQgKiBhcyB0IGZyb20gJ3ZzY29kZS1sYW5ndWFnZXNlcnZlci10eXBlcydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0ICogYXMgYWMgZnJvbSAnYXRvbS9hdXRvY29tcGxldGUtcGx1cydcbmltcG9ydCBBdXRvY29tcGxldGVBZGFwdGVyIGZyb20gJ2F0b20tbGFuZ3VhZ2VjbGllbnQvYnVpbGQvbGliL2FkYXB0ZXJzL2F1dG9jb21wbGV0ZS1hZGFwdGVyJ1xuaW1wb3J0IEFwcGx5RWRpdEFkYXB0ZXIgZnJvbSAnYXRvbS1sYW5ndWFnZWNsaWVudC9idWlsZC9saWIvYWRhcHRlcnMvYXBwbHktZWRpdC1hZGFwdGVyJ1xuaW1wb3J0IE5vdGlmaWNhdGlvbnNBZGFwdGVyIGZyb20gJ2F0b20tbGFuZ3VhZ2VjbGllbnQvYnVpbGQvbGliL2FkYXB0ZXJzL25vdGlmaWNhdGlvbnMtYWRhcHRlcidcbmltcG9ydCBEb2N1bWVudFN5bmNBZGFwdGVyIGZyb20gJ2F0b20tbGFuZ3VhZ2VjbGllbnQvYnVpbGQvbGliL2FkYXB0ZXJzL2RvY3VtZW50LXN5bmMtYWRhcHRlcidcblxuZXhwb3J0IHR5cGUgUmVwb3J0QnVzeSA9IDxUPihcbiAgbXNnOiBzdHJpbmcsXG4gIHByb21pc2VHZW46ICgpID0+IFByb21pc2U8VD4sXG4pID0+IFByb21pc2U8VD5cblxuZXhwb3J0IGNsYXNzIEhpZUxhbmd1YWdlQ2xpZW50IGV4dGVuZHMgQmFzZUxhbmd1YWdlQ2xpZW50IHtcbiAgcHJpdmF0ZSBhdXRvQ29tcGxldGU/OiBBdXRvY29tcGxldGVBZGFwdGVyXG4gIHByaXZhdGUgX2xhc3RBdXRvY29tcGxldGVSZXF1ZXN0PzogYWMuU3VnZ2VzdGlvbnNSZXF1ZXN0ZWRFdmVudFxuICBwcml2YXRlIGVtaXR0ZXI6IEVtaXR0ZXI8XG4gICAge1xuICAgICAgZGVzdHJveWVkOiB2b2lkXG4gICAgfSxcbiAgICB7XG4gICAgICBlcnJvcjogYW55W11cbiAgICAgIHdhcm46IGFueVtdXG4gICAgICBpbmZvOiBhbnlbXVxuICAgICAgbG9nOiBhbnlbXVxuICAgICAgZGVidWc6IGFueVtdXG4gICAgICBtZXNzYWdlczogVVBJLklSZXN1bHRJdGVtW11cbiAgICB9XG4gID4gPSBuZXcgRW1pdHRlcigpXG4gIC8vIHByaXZhdGUgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSBzdGRlcnJCdWYgPSAnJ1xuICBwcml2YXRlIG1lc3NhZ2VzID0gbmV3IE1hcDxzdHJpbmcsIFVQSS5JUmVzdWx0SXRlbVtdPigpXG4gIHByaXZhdGUgcmVwb3J0QnVzeT86IFJlcG9ydEJ1c3lcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5hY3RpdmF0ZSgpXG4gIH1cblxuICBwdWJsaWMgb25FcnJvcihjYjogKGFyZ3M6IGFueVtdKSA9PiB2b2lkKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZXJyb3InLCBjYilcbiAgfVxuXG4gIHB1YmxpYyBvbldhcm5pbmcoY2I6IChhcmdzOiBhbnlbXSkgPT4gdm9pZCkge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ3dhcm4nLCBjYilcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRUeXBlKFxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlcixcbiAgICByYW5nZTogUmFuZ2UsXG4gICk6IFByb21pc2U8eyB0eXBlOiBzdHJpbmc7IHJhbmdlOiBSYW5nZSB9PiB7XG4gICAgY29uc3QgZmlsZVBhdGggPSBidWZmZXIuZ2V0UGF0aCgpXG4gICAgaWYgKGZpbGVQYXRoID09PSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcignTm8gZWRpdG9yIFVSSScpXG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5leGVjdXRlQ29tbWFuZChidWZmZXIsICdnaGNtb2Q6dHlwZScsIHtcbiAgICAgIGZpbGU6IENvbnZlcnQucGF0aFRvVXJpKGZpbGVQYXRoKSxcbiAgICAgIGluY2x1ZGVfY29uc3RyYWludHM6IHRydWUsXG4gICAgICBwb3M6IENvbnZlcnQuYXRvbVJhbmdlVG9MU1JhbmdlKHJhbmdlKS5zdGFydCxcbiAgICB9KVxuICAgIGZvciAoY29uc3QgW3IsIHRdIG9mIHJlcykge1xuICAgICAgY29uc3QgcnIgPSBDb252ZXJ0LmxzUmFuZ2VUb0F0b21SYW5nZShyKVxuICAgICAgaWYgKHJyLmNvbnRhaW5zUmFuZ2UocmFuZ2UpKSByZXR1cm4geyB0eXBlOiB0LCByYW5nZTogcnIgfVxuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHR5cGUgZm91bmQnKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldEluZm8oYnVmZmVyOiBUZXh0QnVmZmVyLCBzeW1ib2w6IHN0cmluZykge1xuICAgIGNvbnN0IGZpbGVQYXRoID0gYnVmZmVyLmdldFBhdGgoKVxuICAgIGlmIChmaWxlUGF0aCA9PT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ05vIGVkaXRvciBVUkknKVxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZXhlY3V0ZUNvbW1hbmQoYnVmZmVyLCAnZ2hjbW9kOmluZm8nLCB7XG4gICAgICBmaWxlOiBDb252ZXJ0LnBhdGhUb1VyaShmaWxlUGF0aCksXG4gICAgICBleHByOiBzeW1ib2wsXG4gICAgfSlcbiAgICByZXR1cm4gcmVzXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVzdGFydCgpIHtcbiAgICByZXR1cm4gdGhpcy5yZXN0YXJ0QWxsU2VydmVycygpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVhY3RpdmF0ZSgpIHtcbiAgICBjb25zdCByZXMgPSBzdXBlci5kZWFjdGl2YXRlKClcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGVzdHJveWVkJylcbiAgICB0aGlzLmVtaXR0ZXIuZGlzcG9zZSgpXG4gICAgcmV0dXJuIHJlc1xuICB9XG5cbiAgcHVibGljIG9uRGlkRGVzdHJveShjYjogKCkgPT4gdm9pZCkge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2Rlc3Ryb3llZCcsIGNiKVxuICB9XG5cbiAgcHVibGljIG9uTWVzc2FnZXMoY2I6IChtc2dzOiBVUEkuSVJlc3VsdEl0ZW1bXSkgPT4gdm9pZCkge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ21lc3NhZ2VzJywgY2IpXG4gIH1cblxuICBwdWJsaWMgZ2V0TWVzc2FnZXMoKTogUmVhZG9ubHlBcnJheTxSZWFkb25seTxVUEkuSVJlc3VsdEl0ZW0+PiB7XG4gICAgcmV0dXJuIGZsYXR0ZW5PbmUodGhpcy5tZXNzYWdlcy52YWx1ZXMoKSlcbiAgfVxuXG4gIHB1YmxpYyBzZXRSZXBvcnRCdXN5KGY6IFJlcG9ydEJ1c3kpIHtcbiAgICB0aGlzLnJlcG9ydEJ1c3kgPSBmXG4gIH1cblxuICAvLyBBdXRvY29tcGxldGUrIHZpYSBMUyBjb21wbGV0aW9uLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHB1YmxpYyBwcm92aWRlQXV0b2NvbXBsZXRlKCk6IGFjLkF1dG9jb21wbGV0ZVByb3ZpZGVyIHtcbiAgICByZXR1cm4ge1xuICAgICAgc2VsZWN0b3I6IHRoaXMuZ2V0R3JhbW1hclNjb3BlcygpXG4gICAgICAgIC5tYXAoKGcpID0+IChnLmluY2x1ZGVzKCcuJykgPyAnLicgKyBnIDogZykpXG4gICAgICAgIC5qb2luKCcsICcpLFxuICAgICAgaW5jbHVzaW9uUHJpb3JpdHk6IDEsXG4gICAgICBzdWdnZXN0aW9uUHJpb3JpdHk6IDIsXG4gICAgICBleGNsdWRlTG93ZXJQcmlvcml0eTogZmFsc2UsXG4gICAgICBnZXRTdWdnZXN0aW9uczogdGhpcy5nZXRTdWdnZXN0aW9ucy5iaW5kKHRoaXMpLFxuICAgICAgZ2V0U3VnZ2VzdGlvbkRldGFpbHNPblNlbGVjdDogdGhpcy5nZXRTdWdnZXN0aW9uRGV0YWlsc09uU2VsZWN0LmJpbmQoXG4gICAgICAgIHRoaXMsXG4gICAgICApLFxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBnZXRTdWdnZXN0aW9ucyhcbiAgICByZXF1ZXN0OiBhYy5TdWdnZXN0aW9uc1JlcXVlc3RlZEV2ZW50LFxuICApOiBQcm9taXNlPGFjLlN1Z2dlc3Rpb25zPiB7XG4gICAgY29uc3Qgc2VydmVyID0gYXdhaXQgdGhpcy5fc2VydmVyTWFuYWdlci5nZXRTZXJ2ZXIocmVxdWVzdC5lZGl0b3IpXG4gICAgaWYgKHNlcnZlciA9PT0gbnVsbCB8fCAhQXV0b2NvbXBsZXRlQWRhcHRlci5jYW5BZGFwdChzZXJ2ZXIuY2FwYWJpbGl0aWVzKSkge1xuICAgICAgcmV0dXJuIFtdXG4gICAgfVxuXG4gICAgdGhpcy5hdXRvQ29tcGxldGUgPSB0aGlzLmF1dG9Db21wbGV0ZSB8fCBuZXcgQXV0b2NvbXBsZXRlQWRhcHRlcigpXG4gICAgdGhpcy5fbGFzdEF1dG9jb21wbGV0ZVJlcXVlc3QgPSByZXF1ZXN0XG4gICAgcmV0dXJuIHRoaXMuYXV0b0NvbXBsZXRlLmdldFN1Z2dlc3Rpb25zKFxuICAgICAgc2VydmVyLFxuICAgICAgcmVxdWVzdCxcbiAgICAgIHVuZGVmaW5lZCxcbiAgICAgIGF0b20uY29uZmlnLmdldCgnYXV0b2NvbXBsZXRlLXBsdXMubWluaW11bVdvcmRMZW5ndGgnKSxcbiAgICApIGFzIFByb21pc2U8YWMuU3VnZ2VzdGlvbnM+XG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgZ2V0U3VnZ2VzdGlvbkRldGFpbHNPblNlbGVjdChcbiAgICBzdWdnZXN0aW9uOiBhYy5UZXh0U3VnZ2VzdGlvbiB8IGFjLlNuaXBwZXRTdWdnZXN0aW9uLFxuICApOiBQcm9taXNlPGFjLlRleHRTdWdnZXN0aW9uIHwgYWMuU25pcHBldFN1Z2dlc3Rpb24gfCBudWxsPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX2xhc3RBdXRvY29tcGxldGVSZXF1ZXN0XG4gICAgaWYgKCFyZXF1ZXN0KSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbnVsbC1rZXl3b3JkXG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cbiAgICBjb25zdCBzZXJ2ZXIgPSBhd2FpdCB0aGlzLl9zZXJ2ZXJNYW5hZ2VyLmdldFNlcnZlcihyZXF1ZXN0LmVkaXRvcilcbiAgICBpZiAoXG4gICAgICAhc2VydmVyIHx8XG4gICAgICAhQXV0b2NvbXBsZXRlQWRhcHRlci5jYW5SZXNvbHZlKHNlcnZlci5jYXBhYmlsaXRpZXMpIHx8XG4gICAgICAhdGhpcy5hdXRvQ29tcGxldGVcbiAgICApIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1udWxsLWtleXdvcmRcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuYXV0b0NvbXBsZXRlLmNvbXBsZXRlU3VnZ2VzdGlvbihcbiAgICAgIHNlcnZlcixcbiAgICAgIHN1Z2dlc3Rpb24sXG4gICAgICByZXF1ZXN0LFxuICAgICkgYXMgUHJvbWlzZTxhYy5UZXh0U3VnZ2VzdGlvbiB8IGFjLlNuaXBwZXRTdWdnZXN0aW9uIHwgbnVsbD5cbiAgfVxuXG4gIHByb3RlY3RlZCBwcmVJbml0aWFsaXphdGlvbihjb25uOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24pIHtcbiAgICBzdXBlci5wcmVJbml0aWFsaXphdGlvbihjb25uKVxuICAgIGNvbm4ub25QdWJsaXNoRGlhZ25vc3RpY3MoKHBhcmFtcykgPT4ge1xuICAgICAgY29uc3QgZmlsZVBhdGggPSBDb252ZXJ0LnVyaVRvUGF0aChwYXJhbXMudXJpKVxuICAgICAgdGhpcy5tZXNzYWdlcy5zZXQoXG4gICAgICAgIHBhcmFtcy51cmksXG4gICAgICAgIGRpYWdub3N0aWNzVG9SZXN1bHRJdGVtcyhmaWxlUGF0aCwgcGFyYW1zLmRpYWdub3N0aWNzKSxcbiAgICAgIClcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdtZXNzYWdlcycsIGZsYXR0ZW5PbmUodGhpcy5tZXNzYWdlcy52YWx1ZXMoKSkpXG4gICAgfSlcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRMb2dnZXIoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHdhcm46ICguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICAgICAgICBjb25zb2xlLndhcm4oLi4uYXJncylcbiAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ3dhcm4nLCBhcmdzKVxuICAgICAgfSxcbiAgICAgIGVycm9yOiAoLi4uYXJnczogYW55W10pID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvciguLi5hcmdzKVxuICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZXJyb3InLCBhcmdzKVxuICAgICAgfSxcbiAgICAgIGluZm86ICguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICAgICAgICBjb25zb2xlLmluZm8oLi4uYXJncylcbiAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2luZm8nLCBhcmdzKVxuICAgICAgfSxcbiAgICAgIGxvZzogKC4uLmFyZ3M6IGFueVtdKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKC4uLmFyZ3MpXG4gICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdsb2cnLCBhcmdzKVxuICAgICAgfSxcbiAgICAgIGRlYnVnOiAoLi4uYXJnczogYW55W10pID0+IHtcbiAgICAgICAgY29uc29sZS5kZWJ1ZyguLi5hcmdzKVxuICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGVidWcnLCBhcmdzKVxuICAgICAgfSxcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0R3JhbW1hclNjb3BlcygpIHtcbiAgICByZXR1cm4gWydzb3VyY2UuaGFza2VsbCddXG4gIH1cbiAgcHJvdGVjdGVkIGdldExhbmd1YWdlTmFtZSgpIHtcbiAgICByZXR1cm4gJ0hhc2tlbGwnXG4gIH1cbiAgcHJvdGVjdGVkIGdldFNlcnZlck5hbWUoKSB7XG4gICAgcmV0dXJuICdoYXNrZWxsLWlkZS1lbmdpbmUnXG4gIH1cblxuICBwcm90ZWN0ZWQgc3RhcnRTZXJ2ZXJQcm9jZXNzKHByb2plY3RQYXRoOiBzdHJpbmcpIHtcbiAgICAvLyBUT0RPOiBidWlsZGVyIHNlbGVjdGlvblxuICAgIC8vIFRPRE86IGhpZGUgZGVidWcgdW5kZXIgZmxhZ1xuICAgIHJldHVybiBjcC5zcGF3bihcbiAgICAgICdzdGFjaycsXG4gICAgICBbXG4gICAgICAgICdleGVjJyxcbiAgICAgICAgJy0tJyxcbiAgICAgICAgYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1oaWUuaGllUGF0aCcpLFxuICAgICAgICAnLS1sc3AnLFxuICAgICAgICAnLS1kZWJ1ZycsXG4gICAgICBdLFxuICAgICAgeyBjd2Q6IHByb2plY3RQYXRoIH0sXG4gICAgKVxuICB9XG5cbiAgcHJvdGVjdGVkIGhhbmRsZVNlcnZlclN0ZGVycihzdGRlcnI6IHN0cmluZywgcHJvamVjdFBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IFtmaXJzdCwgLi4ubGluZXNdID0gc3RkZXJyLnNwbGl0KCdcXG4nKVxuICAgIHRoaXMuc3RkZXJyQnVmICs9IGZpcnN0XG4gICAgaWYgKGxpbmVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oYHN0ZGVyclske3Byb2plY3RQYXRofV06ICR7dGhpcy5zdGRlcnJCdWZ9YClcbiAgICAgIGxpbmVzLnNsaWNlKDAsIC0xKS5mb3JFYWNoKCh4KSA9PiB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYHN0ZGVyclske3Byb2plY3RQYXRofV06ICR7eH1gKVxuICAgICAgfSlcbiAgICAgIHRoaXMuc3RkZXJyQnVmID0gbGluZXNbbGluZXMubGVuZ3RoIC0gMV1cbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgc3RhcnRFeGNsdXNpdmVBZGFwdGVycyhzZXJ2ZXI6IEFjdGl2ZVNlcnZlcik6IHZvaWQge1xuICAgIEFwcGx5RWRpdEFkYXB0ZXIuYXR0YWNoKHNlcnZlci5jb25uZWN0aW9uKVxuICAgIE5vdGlmaWNhdGlvbnNBZGFwdGVyLmF0dGFjaChcbiAgICAgIHNlcnZlci5jb25uZWN0aW9uLFxuICAgICAgdGhpcy5uYW1lLFxuICAgICAgc2VydmVyLnByb2plY3RQYXRoLFxuICAgIClcblxuICAgIGlmIChEb2N1bWVudFN5bmNBZGFwdGVyLmNhbkFkYXB0KHNlcnZlci5jYXBhYmlsaXRpZXMpKSB7XG4gICAgICBzZXJ2ZXIuZGlzcG9zYWJsZS5hZGQoXG4gICAgICAgIG5ldyBEb2N1bWVudFN5bmNBZGFwdGVyKFxuICAgICAgICAgIHNlcnZlci5jb25uZWN0aW9uLFxuICAgICAgICAgIChlZGl0b3IpID0+IHRoaXMuc2hvdWxkU3luY0ZvckVkaXRvcihlZGl0b3IsIHNlcnZlci5wcm9qZWN0UGF0aCksXG4gICAgICAgICAgc2VydmVyLmNhcGFiaWxpdGllcy50ZXh0RG9jdW1lbnRTeW5jLFxuICAgICAgICAgIHRoaXMucmVwb3J0QnVzeVdoaWxlLmJpbmQodGhpcyksXG4gICAgICAgICksXG4gICAgICApXG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIHJlcG9ydEJ1c3lXaGlsZTxUPihcbiAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgcHJvbWlzZUdlbmVyYXRvcjogKCkgPT4gUHJvbWlzZTxUPixcbiAgKTogUHJvbWlzZTxUPiB7XG4gICAgaWYgKHRoaXMucmVwb3J0QnVzeSkge1xuICAgICAgcmV0dXJuIHRoaXMucmVwb3J0QnVzeShtZXNzYWdlLCBwcm9taXNlR2VuZXJhdG9yKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvZ2dlci5pbmZvKG1lc3NhZ2UpXG4gICAgICByZXR1cm4gcHJvbWlzZUdlbmVyYXRvcigpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlQ29tbWFuZChcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsXG4gICAgY29tbWFuZDogJ2doY21vZDp0eXBlJyxcbiAgICBhcmdzOiB7XG4gICAgICBpbmNsdWRlX2NvbnN0cmFpbnRzOiBib29sZWFuXG4gICAgICBmaWxlOiBzdHJpbmdcbiAgICAgIHBvczogdC5Qb3NpdGlvblxuICAgIH0sXG4gICk6IFByb21pc2U8W3QuUmFuZ2UsIHN0cmluZ11bXT5cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlQ29tbWFuZChcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsXG4gICAgY29tbWFuZDogJ2doY21vZDppbmZvJyxcbiAgICBhcmdzOiB7XG4gICAgICBmaWxlOiBzdHJpbmdcbiAgICAgIGV4cHI6IHN0cmluZ1xuICAgIH0sXG4gICk6IFByb21pc2U8c3RyaW5nPlxuICBwcml2YXRlIGFzeW5jIGV4ZWN1dGVDb21tYW5kKFxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlcixcbiAgICBjb21tYW5kOiBzdHJpbmcsXG4gICAgLi4uYXJnczogYW55W11cbiAgKSB7XG4gICAgY29uc3QgY29ubiA9IGF3YWl0IHRoaXMuZ2V0Q29ubmVjdGlvbkZvckJ1ZmZlcihidWZmZXIpXG4gICAgcmV0dXJuIGNvbm4uZXhlY3V0ZUNvbW1hbmQoe1xuICAgICAgY29tbWFuZCxcbiAgICAgIGFyZ3VtZW50czogYXJncyxcbiAgICB9KVxuICB9XG4gIHByaXZhdGUgYXN5bmMgZ2V0Q29ubmVjdGlvbkZvckJ1ZmZlcihidWZmZXI6IFRleHRCdWZmZXIpIHtcbiAgICBjb25zdCBjb25uID0gYXdhaXQgdGhpcy5nZXRDb25uZWN0aW9uRm9yRWRpdG9yKGVkaXRvckZvckJ1ZmZlcihidWZmZXIpKVxuICAgIGlmICghY29ubikgdGhyb3cgbmV3IEVycm9yKCdObyBISUUgY29ubmVjdGlvbicpXG4gICAgcmV0dXJuIGNvbm5cbiAgfVxufVxuXG5mdW5jdGlvbiBlZGl0b3JGb3JCdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyKTogVGV4dEVkaXRvciB7XG4gIGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlXG4gICAgLmdldFRleHRFZGl0b3JzKClcbiAgICAuZmluZCgoZWQpID0+IGVkLmdldEJ1ZmZlcigpID09PSBidWZmZXIpXG4gIGlmICghZWRpdG9yKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYE5vIGVkaXRvciBmb3IgYSBidWZmZXIgJHtidWZmZXIuZ2V0SWQoKX0gd2l0aCBwYXRoICR7YnVmZmVyLmdldFBhdGgoKX1gLFxuICAgIClcbiAgfVxuICByZXR1cm4gZWRpdG9yXG59XG5cbmZ1bmN0aW9uIHNldmVyaXR5TFNUb1VQSShzZXZlcml0eT86IHQuRGlhZ25vc3RpY1NldmVyaXR5KTogVVBJLlRTZXZlcml0eSB7XG4gIHN3aXRjaCAoc2V2ZXJpdHkpIHtcbiAgICBjYXNlIDE6XG4gICAgICByZXR1cm4gJ2Vycm9yJ1xuICAgIGNhc2UgMjpcbiAgICAgIHJldHVybiAnd2FybmluZydcbiAgICBjYXNlIDM6XG4gICAgICByZXR1cm4gJ2xpbnQnXG4gICAgY2FzZSA0OlxuICAgICAgcmV0dXJuICdsaW50J1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gJ0hJRSdcbiAgfVxufVxuXG5mdW5jdGlvbiBkaWFnbm9zdGljc1RvUmVzdWx0SXRlbXMoXG4gIGZpbGVQYXRoOiBzdHJpbmcsXG4gIGRzOiB0LkRpYWdub3N0aWNbXSxcbik6IFVQSS5JUmVzdWx0SXRlbVtdIHtcbiAgcmV0dXJuIGRzLm1hcCgoeCk6IFVQSS5JUmVzdWx0SXRlbSA9PiAoe1xuICAgIG1lc3NhZ2U6IHgubWVzc2FnZSxcbiAgICB1cmk6IGZpbGVQYXRoLFxuICAgIGNvbnRleHQ6IHguc291cmNlLFxuICAgIHNldmVyaXR5OiBzZXZlcml0eUxTVG9VUEkoeC5zZXZlcml0eSksXG4gICAgcG9zaXRpb246IENvbnZlcnQubHNSYW5nZVRvQXRvbVJhbmdlKHgucmFuZ2UpLnN0YXJ0LFxuICB9KSlcbn1cblxuZnVuY3Rpb24gZmxhdHRlbk9uZTxUPihhcnI6IEl0ZXJhYmxlSXRlcmF0b3I8VFtdPik6IFRbXSB7XG4gIHJldHVybiAoW10gYXMgVFtdKS5jb25jYXQoLi4uYXJyKVxufVxuIl19